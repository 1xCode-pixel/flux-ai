<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>FLUX /// BY 1XCODE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-body: #050505; --sidebar-bg: #0a0a0a; --chat-bg: #000000;
            --border: #222; --text-main: #ECECEC; --text-muted: #888;
            --accent: #ffffff; 
            --pro-color: #d4af37; 
            --ultra-color: #b026ff; 
            --admin-color: #ffffff; 
            --danger: #ff4444; --success: #00ff88;
            --frost: rgba(255, 255, 255, 0.03);
        }

        body.tier-pro { --accent: var(--pro-color); }
        body.tier-ultra { --accent: var(--ultra-color); }
        body.tier-admin { --accent: var(--admin-color); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; height: 100dvh; display: flex; overflow: hidden; transition: --accent 0.5s; }

        /* --- STYLES FOR CODE BLOCKS --- */
        pre { background: #111; border: 1px solid #333; border-radius: 8px; margin: 10px 0; overflow: hidden; position: relative; }
        .code-header { background: #1a1a1a; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; font-family: 'Inter', sans-serif; font-size: 0.75rem; color: #888; }
        .copy-code-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .copy-code-btn:hover { color: #fff; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; display: block; padding: 15px; overflow-x: auto; color: #e0e0e0; }

        /* --- MOBILE FIXES --- */
        @media (max-width: 768px) {
            code { font-size: 0.75rem !important; padding: 10px; }
            .code-header { padding: 4px 10px; }
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 85%; transform: translateX(-100%); box-shadow: 5px 0 30px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .top-bar-desktop { display: none; }
            #chat-stream { padding-top: 70px; padding-bottom: 80px; }
            .modal-box { width: 95%; max-height: 85vh; padding: 20px; }
        }

        /* --- ANIMATIONS --- */
        .snowflake { position: absolute; top: -10px; background: #fff; border-radius: 50%; opacity: 0.8; animation: fall linear infinite; pointer-events: none; z-index: 100000; }
        @keyframes fall { to { transform: translateY(105vh); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        @keyframes adminTurbulence {
            0% { transform: rotate(0deg) scale(1); border-radius: 45% 55% 50% 50% / 50% 45% 55% 50%; box-shadow: 0 0 15px 5px rgba(255,255,255,0.5); }
            50% { transform: rotate(180deg) scale(1.05); border-radius: 50% 45% 55% 50% / 45% 55% 50% 50%; box-shadow: 0 0 25px 10px rgba(255,255,255,0.8); }
            100% { transform: rotate(360deg) scale(1); border-radius: 45% 55% 50% 50% / 50% 45% 55% 50%; box-shadow: 0 0 15px 5px rgba(255,255,255,0.5); }
        }
        @keyframes ultraPulse {
            0% { box-shadow: 0 0 10px var(--ultra-color); border-color: var(--ultra-color); }
            50% { box-shadow: 0 0 20px var(--ultra-color), 0 0 40px var(--ultra-color); border-color: #fff; }
            100% { box-shadow: 0 0 10px var(--ultra-color); border-color: var(--ultra-color); }
        }

        /* --- UI CSS --- */
        .message-text { line-height: 1.6; font-size: 1rem; margin-top: 4px; overflow-x: auto; white-space: pre-wrap; }
        .katex { font-size: 1.1em; }
        .typing::after { content: '‚ñã'; animation: blink 1s infinite; margin-left: 2px; color: var(--accent); }
        @keyframes blink { 50% { opacity: 0; } }

        /* INTRO */
        #splash-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 30000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-logo { font-family: 'JetBrains Mono'; font-size: 3rem; font-weight: 800; letter-spacing: -2px; color: #fff; }
        .loading-container { width: 220px; height: 3px; background: #222; border-radius: 3px; margin: 25px 0; overflow: hidden; }
        .loading-bar { height: 100%; width: 0%; background: var(--pro-color); border-radius: 3px; animation: loadProgress 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
        .splash-credit { font-family: 'Inter'; font-size: 0.8rem; letter-spacing: 4px; color: var(--pro-color); opacity: 0; animation: fadeIn 1s ease 1.2s forwards; }
        @keyframes loadProgress { 0% { width: 0%; } 40% { width: 30%; } 70% { width: 85%; } 100% { width: 100%; } }

        /* MAINTENANCE */
        #maint-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #050505; z-index: 29000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #maint-screen.active { display: flex; }
        .maint-panel { background: #0a0a0a; border: 1px solid var(--danger); padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 0 50px rgba(255, 68, 68, 0.15); }
        .maint-icon { font-size: 4rem; margin-bottom: 20px; cursor: pointer; }
        .maint-title { font-family: 'JetBrains Mono'; font-size: 1.4rem; font-weight: bold; color: var(--danger); margin-bottom: 15px; letter-spacing: 2px; }
        .maint-text { color: #aaa; font-size: 0.9rem; line-height: 1.6; margin-bottom: 25px; }
        .maint-timer { font-family: 'JetBrains Mono'; font-size: 2rem; color: #fff; background: #111; border: 1px solid #333; padding: 15px; border-radius: 12px; margin-bottom: 20px; letter-spacing: 2px; }

        /* MODALS (FIXED) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 20000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-overlay.active { display: flex; animation: zoomIn 0.25s ease; }
        .modal-box { background: #0a0a0a; border: 1px solid #333; padding: 25px; border-radius: 20px; width: 95%; max-width: 550px; text-align: center; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.9); }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #666; cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .close-btn:hover { color: #fff; }

        /* BUTTONS */
        .auth-btn { background: #fff; color: #000; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; font-size: 0.9rem; transition: 0.2s; }
        .auth-btn:hover { opacity: 0.9; }

        /* LAYOUT */
        #app { display: flex; width: 100%; height: 100%; flex-direction: row; }
        .sidebar { width: 280px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2000; position: relative; }
        .logo { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 1.4rem; display: flex; align-items: center; gap: 8px; margin-bottom: 25px; }
        .btn-new-chat { width: 100%; padding: 12px; background: var(--frost); border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .history-item { padding: 12px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; color: #aaa; display: flex; justify-content: space-between; }
        .history-item:hover { background: #1a1a1a; color: #fff; }
        .delete-btn { background: transparent; border: none; color: #444; cursor: pointer; padding: 0 10px; display: flex; opacity: 0; font-size: 1.2rem; }
        .history-item:hover .delete-btn { opacity: 1; }
        .sidebar-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .user-profile { display: flex; align-items: center; gap: 10px; padding: 5px; user-select: none; }
        .user-avatar { width: 36px; height: 36px; background: #222; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #333; transition: 0.3s; position: relative; z-index: 2; }
        #userId { font-size: 0.7rem; color: #666; font-family: 'JetBrains Mono'; cursor: pointer; margin-top: 2px; }
        #userId:hover { color: var(--accent); }
        .footer-credit { font-size: 0.65rem; color: #444; text-align: center; font-family: 'JetBrains Mono'; margin-top: 5px; cursor: default; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; width: 100%; height: 100%; }
        .mobile-header { display: none; height: 60px; padding: 0 15px; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; background: rgba(10,10,10,0.95); backdrop-filter: blur(10px); position: absolute; top: 0; left: 0; width: 100%; z-index: 50; }
        .top-bar-desktop { padding: 15px; display: flex; justify-content: flex-end; position: absolute; top: 0; left: 0; right: 0; z-index: 10; pointer-events: none; }
        .top-bar-desktop > * { pointer-events: auto; }

        #chat-stream { flex: 1; overflow-y: auto; padding: 80px 20px 20px 20px; scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
        .message-container { max-width: 800px; margin: 0 auto 25px auto; display: flex; gap: 15px; animation: slideUp 0.3s ease forwards; }
        .avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; transition: 0.5s; position: relative; z-index: 1; }
        .avatar.ai { background: #fff; color: #000; }
        .avatar.user { background: #222; color: #fff; }

        .input-wrapper { max-width: 800px; margin: 0 auto; width: 100%; padding: 15px; background: linear-gradient(to top, #000 80%, transparent); display: flex; flex-direction: column; z-index: 60; }
        .input-box { background: #111; border: 1px solid var(--border); border-radius: 14px; padding: 10px 14px; display: flex; align-items: flex-end; gap: 10px; transition: 0.2s; }
        .input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 20px rgba(255,255,255,0.05); }
        textarea { width: 100%; background: transparent; border: none; color: white; font-family: inherit; font-size: 1rem; resize: none; outline: none; max-height: 120px; padding: 10px 0; line-height: 1.3; }
        .file-preview { display: none; padding: 8px 12px; margin-bottom: 8px; background: #1a1a1a; border-radius: 8px; font-size: 0.8rem; color: #ccc; align-items: center; justify-content: space-between; max-width: 800px; margin: 0 auto 10px auto; border: 1px dashed #444; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 900; display: none; }
        .overlay.active { display: block; }
        .burger-btn { background: none; border: none; color: #fff; cursor: pointer; padding: 5px; font-size: 1.5rem; }

        /* BUTTON PLUS AND MENU */
        .btn-plus { background: transparent; border: 1px solid #444; color: #aaa; border-radius: 50%; width: 30px; height: 30px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 6px; transition: 0.2s; }
        .btn-plus:hover { color: #fff; border-color: #fff; background: #222; }
        .action-menu { position: absolute; bottom: 60px; left: 15px; background: #111; border: 1px solid #333; border-radius: 10px; display: none; flex-direction: column; overflow: hidden; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.8); min-width: 160px; }
        .action-menu.active { display: flex; animation: slideUp 0.15s ease; }
        .action-item { padding: 12px 15px; color: #ccc; font-size: 0.9rem; cursor: pointer; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #222; }
        .action-item:last-child { border-bottom: none; }
        .action-item:hover { background: #222; color: #fff; }
        .code-mode-active .input-box { border-color: var(--success); box-shadow: 0 0 10px rgba(0,255,136,0.1); }
        .code-mode-active textarea { color: var(--success); }

        /* CUSTOM MODAL & MODEL SELECTOR */
        .modal-container { background: #0a0a0a; border: 1px solid #333; width: 90%; max-width: 600px; border-radius: 16px; padding: 20px; position: relative; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .modal-header h2 { margin: 0; color: #fff; font-size: 1.2rem; }
        .modal-close { background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .header-right-group { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .tokens-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; color: #fff; transition: all 0.3s; }
        .tokens-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
        .model-btn-custom { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px 16px; cursor: pointer; transition: all 0.3s ease; color: #fff; font-family: inherit; }
        .model-btn-custom:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .model-avatar-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .model-text-info { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .model-name-main { font-size: 0.95em; font-weight: 500; color: #fff; }
        .model-cost-label { font-size: 0.75em; color: rgba(255,255,255,0.6); }
        .model-item { padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .model-item:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); transform: translateX(5px); }
        .model-item.active { background: rgba(102,126,234,0.2); border-color: #667eea; }
        .model-name { color: #fff; font-weight: 600; font-size: 1.1em; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .model-info { color: rgba(255,255,255,0.6); font-size: 0.85em; }
        .model-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; }
        .badge-free { background: rgba(74,222,128,0.2); color: #4ade80; }
        .badge-paid { background: rgba(251,191,36,0.2); color: #fbbf24; }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="splash-screen">
        <div class="splash-logo">FLUX üéÑ AI</div>
        <div class="loading-container"><div class="loading-bar"></div></div>
        <div class="splash-credit">BY 1XCODE</div>
    </div>

    <div id="tokensModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>üíé –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤</h2>
                <button class="modal-close" onclick="closeTokensModal()">&times;</button>
            </div>
            <div style="text-align:center;padding:20px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;">
                <div style="color:rgba(255,255,255,0.6);margin-bottom:8px;">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</div>
                <div id="currentBalance" style="color:#fff;font-size:1.8em;font-weight:700;">0 —Ç–æ–∫–µ–Ω–æ–≤</div>
            </div>
            <input type="text" id="activationCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;margin-bottom:10px;">
            <button id="activateCodeBtn" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;">‚ú® –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="activationResultMsg" style="display:none;padding:12px;margin-top:10px;border-radius:6px;text-align:center;"></div>
        </div>
    </div>

    <div id="modelModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2>ü§ñ –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏</h2>
                <button class="modal-close" onclick="closeModelModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height:500px;overflow-y:auto;">
                <div id="modelsList"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>

    <div id="app">
        <aside class="sidebar" id="sidebar">
            <div class="logo">FLUX <span>AI</span> 
                <div class="pro-badge-logo" id="proBadge">PRO</div>
            </div>
            <button class="btn-new-chat" onclick="startNewChat()">+ –ù–æ–≤—ã–π —á–∞—Ç</button>
            <div class="history-list" id="historyList"></div>
            <div class="sidebar-footer">
                <button onclick="localStorage.clear();location.reload();" style="background:none; border:none; color:#666; cursor:pointer; font-size: 0.8rem; text-align: left;">üóë –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>
                <div class="user-profile">
                    <div class="user-avatar" id="myAvatar">U</div>
                    <div class="user-info">
                        <div style="font-size:0.9rem;" id="userName">–ì–æ—Å—Ç—å</div>
                        <div style="font-size:0.65rem; color:#666; font-family: 'JetBrains Mono';" id="userId" onclick="copyID()">UID...</div>
                    </div>
                </div>
                <div class="footer-credit" id="secretTrigger">CREATED BY <span>1XCODE</span></div>
            </div>
        </aside>

        <main class="main-content">
            <header class="mobile-header">
                <button class="burger-btn" onclick="toggleSidebar(true)">‚ò∞</button>
                <div class="header-right-group">
                    <button class="tokens-btn" id="tokensBtnMob" onclick="openTokensModal()">
                        <span class="token-icon">üíé</span> <span class="token-count" id="tokenCountMob">0</span>
                    </button>
                    <button class="model-btn-custom" id="mobModelBtn" onclick="openModelModal()">
                        <img class="model-avatar-img" id="mobModelAvatar" src="" alt="">
                        <span class="model-name-short" id="mobModelName">–í—ã–±—Ä–∞—Ç—å</span>
                    </button>
                </div>
            </header>

            <div class="top-bar-desktop">
                <div class="header-right-group">
                    <button class="tokens-btn" id="tokensBtnDesk" onclick="openTokensModal()">
                        <span class="token-icon">üíé</span> <span class="token-count" id="tokenCountDesk">0</span>
                    </button>
                    <button class="model-btn-custom" id="deskModelBtn" onclick="openModelModal()">
                        <img class="model-avatar-img" id="deskModelAvatar" src="" alt="">
                        <div class="model-text-info">
                            <span class="model-name-main" id="deskModelName">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</span>
                            <span class="model-cost-label" id="deskModelCost">-</span>
                        </div>
                    </button>
                </div>
            </div>

            <div id="chat-stream">
                <div class="message-container">
                    <div class="avatar ai">‚óà</div>
                    <div class="message-text">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ —á–∞—Ç! üéÑ</div>
                </div>
            </div>

            <div class="file-preview" id="filePreview"><span>üìÑ <span id="fileName">file</span></span><span style="cursor:pointer;" onclick="clearFile()">‚úï</span></div>

            <div class="input-wrapper" id="inputWrapper">
                <div class="input-box">
                    <div style="position: relative;">
                        <button class="btn-plus" onclick="toggleActionMenu()">+</button>
                        <div class="action-menu" id="actionMenu">
                            <div class="action-item" onclick="triggerFileUpload()"><i class="fas fa-image"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
                            <div class="action-item" onclick="toggleCodeMode()"><i class="fas fa-code"></i> Flux Coder</div>
                        </div>
                    </div>
                    <input type="file" id="fileIn" style="display:none" onchange="handleFile(this)">
                    <textarea id="userInput" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button class="auth-btn" style="margin:0; padding:0; width:35px; height:35px;" onclick="sendMsg()">‚Üí</button>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span style="font-size: 0.7rem; color: #444; cursor: pointer; text-decoration: underline;" onclick="openLegal()">–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (1xCode Agreement)</span>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô URL –î–õ–Ø VERCEL:
        const API_URL = '/api'; 

        let chats = JSON.parse(localStorage.getItem('chats_v57') || '[]');
        let myUID = localStorage.getItem('myUID') || 'u-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('myUID', myUID);
        let activeId = null;
        let currFile = null;
        let isCodeMode = false;

        const PROMO_CODES = {'FREE500':500,'PREMIUM10K':10000,'VIP':50000};
        const MODELS=[
            {id:'mistralai/mistral-7b-instruct:free',name:'Mistral 7B',provider:'Mistral AI',siteFree:true,vision:false,cost:0},
            {id:'google/gemma-2-9b-it:free',name:'Gemma 2 9B',provider:'Google',siteFree:true,vision:false,cost:0},
            {id:'meta-llama/llama-3.2-11b-vision-instruct:free',name:'Llama 3.2 11B',provider:'Meta',siteFree:true,vision:true,cost:0},
            {id:'meta-llama/llama-3.3-70b-instruct:free',name:'Llama 3.3 70B',provider:'Meta',siteFree:false,vision:false,cost:100},
            {id:'qwen/qwen-2.5-coder-32b-instruct:free',name:'Qwen 2.5 Coder',provider:'Qwen',siteFree:false,vision:false,cost:80},
            {id:'google/gemini-2.0-flash-exp:free',name:'Gemini 2.0 Flash',provider:'Google',siteFree:false,vision:true,cost:150}
        ];
        let currentModel=MODELS[0];

        function getBalance(){return parseInt(localStorage.getItem('userTokens')||'0')}
        function setBalance(amount){localStorage.setItem('userTokens',amount.toString())}
        function updateBalanceDisplay(){
            const bal=getBalance();
            ['tokenCountMob','tokenCountDesk'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerText=bal});
            const cur=document.getElementById('currentBalance');if(cur)cur.innerText=bal+' —Ç–æ–∫–µ–Ω–æ–≤';
        }

        window.openTokensModal=function(){document.getElementById('tokensModal').classList.add('active');updateBalanceDisplay()}
        window.closeTokensModal=function(){document.getElementById('tokensModal').classList.remove('active')}
        
        window.openModelModal=function(){
            document.getElementById('modelModal').classList.add('active');
            const list=document.getElementById('modelsList');
            let html='';
            MODELS.forEach(m => {
                const active = currentModel.id === m.id ? 'active' : '';
                const cost = m.siteFree ? 'FREE' : `üíé ${m.cost}`;
                html += `<div class="model-item ${active}" onclick="selectModel('${m.id}')">
                            <div class="model-name">${m.name} <span class="model-badge badge-free">${cost}</span></div>
                            <div class="model-info">${m.provider}</div>
                         </div>`;
            });
            list.innerHTML=html;
        }
        window.closeModelModal=function(){document.getElementById('modelModal').classList.remove('active')}
        window.selectModel=function(id){
            const m = MODELS.find(x=>x.id===id);
            if(m){
                if(!m.siteFree && getBalance()<m.cost){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤!'); openTokensModal(); return; }
                currentModel=m; 
                document.getElementById('mobModelName').innerText = m.name;
                document.getElementById('deskModelName').innerText = m.name;
                closeModelModal();
            }
        }

        // --- CORE CHAT LOGIC ---
        window.onload = () => {
            document.getElementById('userId').innerText = "UID: " + myUID;
            updateBalanceDisplay();
            selectModel(currentModel.id);
            createSnow();
            setTimeout(()=>document.getElementById('splash-screen').style.display='none', 2000);
            if(chats.length) { chats.sort((a,b)=>b.ts-a.ts); loadChat(chats[0].id); }
        }

        window.toggleActionMenu = () => document.getElementById('actionMenu').classList.toggle('active');
        window.triggerFileUpload = () => { document.getElementById('fileIn').click(); toggleActionMenu(); }
        window.toggleCodeMode = () => {
            isCodeMode = !isCodeMode;
            const area = document.getElementById('userInput');
            if(isCodeMode) { document.body.classList.add('code-mode-active'); area.placeholder="Flux Coder Mode..."; }
            else { document.body.classList.remove('code-mode-active'); area.placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."; }
            toggleActionMenu();
        }

        window.sendMsg = async () => {
            const txt = document.getElementById('userInput').value.trim();
            if(!txt && !currFile) return;
            
            // Check tokens
            if(!currentModel.siteFree) {
                if(getBalance() < currentModel.cost) { alert('–ù—É–∂–Ω—ã —Ç–æ–∫–µ–Ω—ã!'); openTokensModal(); return; }
                setBalance(getBalance() - currentModel.cost);
                updateBalanceDisplay();
            }

            if(!activeId) {
                const nid = Date.now();
                chats.unshift({id:nid, title: txt.slice(0,15)||'–ß–∞—Ç', ts:nid, msgs:[]});
                activeId = nid;
            }
            const c = chats.find(x=>x.id===activeId);
            c.msgs.push({role:'user', text:txt, file:currFile});
            appendMsg('user', txt, currFile);
            
            const payload = {
                message: txt,
                file: currFile ? currFile.data : null,
                uid: myUID,
                model: currentModel.id,
                mode: isCodeMode ? 'code' : 'general'
            };

            document.getElementById('userInput').value=''; currFile=null;
            document.getElementById('filePreview').style.display='none';
            renderHistory();

            const aiDiv = appendMsg('ai', '', null, true);
            const textEl = aiDiv.querySelector('.message-text');
            textEl.classList.add('typing');

            try {
                const res = await fetch(API_URL + '/chat', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                textEl.classList.remove('typing');
                textEl.innerHTML = marked.parse(data.reply);
                // Add Copy Button to Code Blocks
                textEl.querySelectorAll('pre code').forEach((block) => {
                    const pre = block.parentElement;
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `<span>Code</span> <button class="copy-code-btn" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">üìã Copy</button>`;
                    pre.insertBefore(header, block);
                });
                
                c.msgs.push({role:'ai', text:data.reply});
                localStorage.setItem('chats_v57', JSON.stringify(chats));
            } catch(e) {
                textEl.innerText = "–û—à–∏–±–∫–∞: " + e.message;
            }
        }

        window.appendMsg = (role, text, file, anim) => {
            const d = document.createElement('div'); d.className='message-container';
            let fh = file ? `<div>üìÑ ${file.name}</div>` : '';
            let content = anim ? `<div class="message-text typing"></div>` : `<div class="message-text">${marked.parse(text)}</div>`;
            d.innerHTML = `<div class="avatar ${role}">${role==='user'?'U':'‚óà'}</div><div>${fh}${content}</div>`;
            document.getElementById('chat-stream').appendChild(d);
            // Render Math
            if(!anim && role==='ai') renderMathInElement(d);
            // Render Code Copy
            if(!anim && role==='ai') {
                d.querySelectorAll('pre code').forEach((block) => {
                    const pre = block.parentElement;
                    if(!pre.querySelector('.code-header')) {
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>Code</span> <button class="copy-code-btn" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">üìã Copy</button>`;
                        pre.insertBefore(header, block);
                    }
                });
            }
            return d;
        }

        // --- UTILS ---
        window.handleFile = function(i) {
            const f = i.files[0];
            if(f){
                const r = new FileReader();
                r.onload = e => {
                    currFile = {name:f.name, type:f.type, data:e.target.result};
                    document.getElementById('filePreview').style.display='flex';
                    document.getElementById('fileName').innerText=f.name;
                };
                r.readAsDataURL(f);
            }
        }
        window.clearFile = function() { currFile = null; document.getElementById('filePreview').style.display='none'; }
        window.copyID = () => navigator.clipboard.writeText(myUID);
        window.openLegal = () => document.getElementById('legalModal').classList.add('active');
        window.startNewChat = () => { activeId=null; document.getElementById('chat-stream').innerHTML=''; renderHistory(); }
        window.loadChat = (id) => { 
            const c=chats.find(x=>x.id===id); 
            if(c){ activeId=id; document.getElementById('chat-stream').innerHTML=''; c.msgs.forEach(m=>appendMsg(m.role,m.text,m.file)); renderHistory(); }
        }
        window.renderHistory = () => {
            const l=document.getElementById('historyList'); l.innerHTML='';
            chats.forEach(c => {
                const i=document.createElement('div'); i.className='history-item';
                i.innerHTML=`<span>${c.title}</span>`;
                i.onclick=()=>loadChat(c.id);
                l.appendChild(i);
            });
        }
        function createSnow() { /* ... snow logic ... */ }
    </script>
</body>
</html>



































































